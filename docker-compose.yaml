version: '3.8'

services:
  mbbank-api:
    build:
      context: .
      dockerfile: transaction/dockerfile
    container_name: mbbank-transaction-api
    ports:
      - "8000:8000"
    environment:
      - MB_USERNAME=${MB_USERNAME}
      - MB_PASSWORD=${MB_PASSWORD}
      - MB_ACCOUNT_NO=${MB_ACCOUNT_NO}
      - WEBHOOK_URL=${WEBHOOK_URL:-http://host.docker.internal:3000/api/v1/payment/webhook}
      - WEBHOOK_SECRET=${WEBHOOK_SECRET:-your-webhook-secret}
      - POLL_INTERVAL=${POLL_INTERVAL:-30}
    extra_hosts:
      - "host.docker.internal:host-gateway"  # Để container gọi được localhost của host
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8000/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    
  # Test service
  test:
    image: curlimages/curl:latest
    depends_on:
      - mbbank-api
    command: >
      sh -c "
        echo 'Waiting for API...';
        sleep 10;
        echo '\n=== Testing API ===';
        echo '\n1. Health Check:';
        curl -s http://mbbank-api:8000/health | python -m json.tool || echo 'Failed';
        echo '\n\n2. API Documentation:';
        echo 'Swagger UI: http://localhost:8000/docs';
        echo 'ReDoc: http://localhost:8000/redoc';
        echo '\n\n✅ API is ready!';
      "
    profiles:
      - test

#   postgres:
#     image: postgres:16-alpine
#     container_name: study_postgres
#     restart: unless-stopped
#     environment:
#       POSTGRES_DB: ${POSTGRES_DB}
#       POSTGRES_USER: ${POSTGRES_USER}
#       POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
#       PGDATA: /var/lib/postgresql/data/pgdata
#     ports:
#       - "5432:5432"
#     volumes:
#       - postgres_data:/var/lib/postgresql/data
#     networks:
#       - study_network
#     healthcheck:
#       test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER} -d ${POSTGRES_DB}"]
#       interval: 10s
#       timeout: 5s
#       retries: 5
#     logging:
#       driver: "json-file"
#       options:
#         max-size: "10m"
#         max-file: "3"
#     deploy:
#       resources:
#         limits:
#           cpus: "1.0"
#           memory: "512M"

#   # Redis Cache
#   redis:
#     image: redis:7-alpine
#     container_name: study_redis
#     restart: unless-stopped
#     command: redis-server --requirepass ${REDIS_PASSWORD} --maxmemory 256mb --maxmemory-policy allkeys-lru
#     ports:
#       - "6379:6379"
#     volumes:
#       - redis_data:/data
#     networks:
#       - study_network
#     healthcheck:
#       test: ["CMD", "redis-cli", "-a", "${REDIS_PASSWORD}", "ping"]
#       interval: 10s
#       timeout: 5s
#       retries: 5
#     logging:
#       driver: "json-file"
#       options:
#         max-size: "10m"
#         max-file: "3"

#   minio:
#     image: minio/minio:latest
#     container_name: cybercafe_minio
#     restart: unless-stopped
#     command: server /data --console-address ":9001"
#     environment:
#       MINIO_ROOT_USER: ${MINIO_ROOT_USER}
#       MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD}
#     ports:
#       - "9000:9000"  # API Port
#       - "9090:9001"
#     volumes:
#       - minio_data:/data
#     networks:
#       - study_network
#     healthcheck:
#       test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
#       interval: 30s
#       timeout: 20s
#       retries: 3
#     logging:
#       driver: "json-file"
#       options:
#         max-size: "10m"
#         max-file: "3"

#   minio_createbuckets:
#     image: minio/mc:latest
#     container_name: cybercafe_minio_setup
#     depends_on:
#       minio:
#         condition: service_healthy
#     entrypoint: >
#       /bin/sh -c "
#       echo 'Waiting for MinIO to be ready...';
#       sleep 10;
#       echo 'Configuring MinIO...';
#       /usr/bin/mc alias set myminio http://minio:9000 ${MINIO_ROOT_USER} ${MINIO_ROOT_PASSWORD};
#       echo 'Creating buckets...';
#       /usr/bin/mc mb myminio/study-media --ignore-existing;
#       /usr/bin/mc mb myminio/study-avatars --ignore-existing;
#       /usr/bin/mc mb myminio/study-documents --ignore-existing;
#       /usr/bin/mc mb myminio/study-assignments --ignore-existing;
#       echo 'MinIO setup completed successfully!';
#       exit 0;
#       "
#     networks:
#       - study_network
    
  

# networks:
#   study_network:
#     driver: bridge

# volumes:
#   postgres_data:
#     name: study_postgres_data
#   redis_data:
#     name: study_redis_data
#   minio_data:
#     name: study_minio_data
